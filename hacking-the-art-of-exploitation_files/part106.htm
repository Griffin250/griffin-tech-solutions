<!DOCTYPE  html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>0x474 Idle Scanning</title><link href="navigation.css" rel="stylesheet" type="text/css"/><link href="document.css" rel="stylesheet" type="text/css"/></head><body><p class="top_nav"><a href="part105.htm">&lt; Previous</a><span> | </span><a href="../hacking-the-art-of-exploitation.html">Contents</a><span> | </span><a href="part107.htm">Next &gt;</a></p><p class="s32" style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><a name="bookmark95">0x474 Idle Scanning</a></p><p style="padding-top: 6pt;padding-left: 91pt;text-indent: 0pt;text-align: left;">Idle scanning is a way to scan a target using spoofed packets from an idle host, by observing changes in the idle host. The attacker needs to find a usable idle host that is not sending or receiving any other network traffic and that has a TCP implementation that produces predictable IP IDs that change by a known increment with each packet. IP IDs are meant to be unique per packet per session, and they are commonly incremented by a fixed amount. Predictable IP IDs have never really been considered a security risk, and idle scanning takes advantage of this misconception. Newer operating systems, such as the recent Linux kernel, OpenBSD, and Windows Vista, randomize the IP ID, but older operating systems and hardware (such as printers) typically do not.</p><p style="padding-left: 91pt;text-indent: 17pt;text-align: left;">First, the attacker gets the current IP ID of the idle host by contacting it with a SYN packet or an unsolicited SYN/ACK packet and observing the IP ID of the response. By repeating this process a few more times, the incre- ment applied to the IP ID with each packet can be determined.</p><p style="padding-left: 91pt;text-indent: 17pt;text-align: left;">Then, the attacker sends a spoofed SYN packet with the idle host’s IP address to a port on the target machine. One of two things will happen, depending on whether that port on the victim machine is listening:</p><p class="s94" style="padding-top: 8pt;padding-left: 109pt;text-indent: -18pt;text-align: left;">•  <span class="p">If that port is listening, a SYN/ACK packet will be sent back to the idle host. But since the idle host didn’t actually send out the initial SYN packet, this response appears to be unsolicited to the idle host, and it responds by sending back an RST packet.</span></p><p class="s94" style="padding-top: 3pt;padding-left: 109pt;text-indent: -18pt;text-align: left;">•  <span class="p">If that port isn’t listening, the target machine doesn’t send a SYN/ACK packet back to the idle host, so the idle host doesn’t respond.</span></p><p style="padding-top: 3pt;padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: left;">At this point, the attacker contacts the idle host again to determine how much the IP ID has incremented. If it has only incremented by one interval, no other packets were sent out by the idle host between the two checks. This implies that the port on the target machine is closed. If the IP ID has incre- mented by two intervals, one packet, presumably an RST packet, was sent out by the idle machine between the checks. This implies that the port on the target machine is open.</p><p style="padding-left: 109pt;text-indent: 0pt;line-height: 11pt;text-align: left;">The steps are illustrated on the next page for both possible outcomes.</p><p style="padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: left;">Of course, if the idle host isn’t truly idle, the results will be skewed. If there is light traffic on the idle host, multiple packets can be sent for each port. If 20 packets are sent, then a change of 20 incremental steps should be an indication of an open port, and none, of a closed port. Even if there is light traffic, such as one or two non–scan-related packets sent by the idle host, this difference is large enough that it can still be detected.</p><p style="padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: justify;">If this technique is used properly on an idle host that doesn’t have any logging capabilities, the attacker can scan any target without ever revealing his or her IP address.</p><p style="padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: justify;">After finding a suitable idle host, this type of scanning can be done with nmap using the <span class="s31">-sI </span>command-line option followed by the idle host’s address:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Image_783.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="21" height="21" alt="image" src="Image_784.png"/></span></p><p class="s89" style="padding-top: 2pt;text-indent: 0pt;text-align: center;">3</p><p style="text-indent: 0pt;text-align: left;"/><p class="s31" style="padding-bottom: 3pt;padding-left: 37pt;text-indent: 0pt;text-align: center;">reader@hacking:~/booksrc $ sudo nmap -sI idlehost.com 192.168.42.7</p><p style="padding-left: 91pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Image_785.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">Attacker</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">Idle host</p><p style="text-indent: 0pt;text-align: left;"/><p class="s91" style="padding-top: 5pt;padding-left: 105pt;text-indent: 0pt;text-align: left;">Port open on target</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="113" height="4" alt="image" src="Image_786.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="113" height="4" alt="image" src="Image_787.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="21" height="21" alt="image" src="Image_788.png"/></span></p><p class="s89" style="padding-top: 2pt;text-indent: 0pt;text-align: center;">2</p><p style="text-indent: 0pt;text-align: left;"/><p class="s82" style="padding-left: 13pt;text-indent: 4pt;line-height: 233%;text-align: left;">SYN/ACK RST (ID = 52)</p><p class="s82" style="padding-top: 7pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">Last ID from idle host = 50</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="71" alt="image" src="Image_789.png"/></span></p><p class="s82" style="padding-top: 6pt;padding-left: 25pt;text-indent: 0pt;text-align: right;">SYN/ACK</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="4" height="70" alt="image" src="Image_790.png"/></span></p><p class="s82" style="padding-top: 6pt;padding-left: 15pt;text-indent: 0pt;text-align: left;">RST (ID = 51)</p><p class="s89" style="padding-top: 5pt;text-indent: 0pt;text-align: center;">1</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="176" height="94" alt="image" src="Image_791.png"/></span></p><p class="s82" style="padding-left: 51pt;text-indent: 0pt;line-height: 8pt;text-align: left;">SYN</p><p style="text-indent: 0pt;text-align: left;"><span><img width="21" height="21" alt="image" src="Image_792.png"/></span></p><p class="s89" style="padding-top: 2pt;text-indent: 0pt;text-align: center;">2</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">Target</p><p style="text-indent: 0pt;text-align: left;"/><p class="s82" style="padding-left: 243pt;text-indent: 0pt;text-align: left;">Spoofed with idle host as the source address</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 98pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="318" height="1" alt="image" src="Image_793.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">Idle host</p><p style="text-indent: 0pt;text-align: left;"/><p class="s91" style="padding-top: 7pt;padding-left: 107pt;text-indent: 0pt;text-align: left;">Port closed on target</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><span><img width="113" height="4" alt="image" src="Image_794.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="113" height="4" alt="image" src="Image_795.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><span><img width="176" height="95" alt="image" src="Image_796.png"/></span></p><p class="s89" style="text-indent: 0pt;text-align: left;">1</p><p style="text-indent: 0pt;text-align: left;"/><p class="s82" style="text-indent: 0pt;text-align: left;">SYN</p><p class="s82" style="text-indent: 0pt;text-align: left;">Spoofed with idle host as the source address</p><p style="text-indent: 0pt;text-align: left;"/><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-left: 16pt;text-indent: 0pt;text-align: left;">Attacker</p><p style="text-indent: 0pt;text-align: left;"/><p class="s82" style="padding-top: 7pt;padding-left: 7pt;text-indent: 4pt;line-height: 233%;text-align: left;">SYN/ACK RST (ID = 51)</p><p class="s82" style="padding-top: 5pt;padding-left: 33pt;text-indent: 0pt;text-align: left;">Last ID from idle host = 50</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s89" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">Target</p><p style="padding-left: 104pt;text-indent: 0pt;text-align: left;"/><p class="nav">&nbsp;&nbsp;</p><p class="nav">&nbsp;</p><p class="nav"><a href="part105.htm">&lt; Previous</a><span> | </span><a href="../hacking-the-art-of-exploitation.html">Contents</a><span> | </span><a href="part107.htm">Next &gt;</a></p><p class="nav">&nbsp;&nbsp;</p></body></html>
