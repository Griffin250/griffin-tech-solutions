<!DOCTYPE  html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>0x432 Network Layer</title><link href="navigation.css" rel="stylesheet" type="text/css"/><link href="document.css" rel="stylesheet" type="text/css"/></head><body><p class="top_nav"><a href="part84.htm">&lt; Previous</a><span> | </span><a href="../hacking-the-art-of-exploitation.html">Contents</a><span> | </span><a href="part86.htm">Next &gt;</a></p><p class="s32" style="padding-top: 4pt;padding-left: 91pt;text-indent: 0pt;text-align: left;"><a name="bookmark74">0x432 Network Layer</a></p><p style="padding-top: 7pt;padding-left: 91pt;text-indent: 0pt;line-height: 108%;text-align: left;">The network layer is like a worldwide postal service providing an addressing and delivery method used to send things everywhere. The protocol used at this layer for Internet addressing and delivery is, appropriately, called Internet Protocol (IP); the majority of the Internet uses IP version 4.</p><p style="padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: left;">Every system on the Internet has an IP address, consisting of a familiar four-byte arrangement in the form of <span class="s31">xx.xx.xx.xx</span>. The IP header for packets in this layer is 20 bytes in size and consists of various fields and bitflags as defined in RFC 791.</p><p class="s40" style="padding-top: 9pt;padding-left: 91pt;text-indent: 0pt;text-align: left;">From RFC 791</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Image_665.png"/></span></p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;text-align: left;">[Page 10]</p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;text-align: left;">September 1981</p><p class="s31" style="padding-left: 325pt;text-indent: 0pt;text-align: left;">Internet Protocol</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-top: 4pt;padding-left: 206pt;text-indent: 0pt;text-align: left;">3. SPECIFICATION</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;text-align: left;">3.1. Internet Header Format</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-left: 16pt;text-indent: 0pt;text-align: center;">A summary of the contents of the internet header follows:</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-left: 108pt;text-indent: 0pt;text-align: left;">0          1          2          3</p><p class="s31" style="padding-left: 108pt;text-indent: 0pt;text-align: left;">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</p><p class="s31" style="padding-left: 104pt;text-indent: 0pt;text-align: left;">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</p><p class="s31" style="padding-left: 104pt;text-indent: 0pt;text-align: left;">|Version|  IHL  |Type of Service|      Total Length     |</p><p class="s31" style="padding-left: 104pt;text-indent: 0pt;text-align: left;">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</p><p class="s31" style="padding-left: 104pt;text-indent: 0pt;text-align: left;">|     Identification     |Flags|    Fragment Offset  |</p><p class="s31" style="padding-left: 104pt;text-indent: 0pt;text-align: left;">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</p><p class="s31" style="padding-left: 104pt;text-indent: 0pt;text-align: left;">| Time to Live |  Protocol  |     Header Checksum    |</p><p class="s31" style="padding-left: 104pt;text-indent: 0pt;text-align: left;">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</p><p class="s31" style="padding-left: 104pt;text-indent: 0pt;text-align: left;">|            Source Address              |</p><p class="s31" style="padding-left: 104pt;text-indent: 0pt;text-align: left;">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</p><p class="s31" style="padding-left: 104pt;text-indent: 0pt;text-align: left;">|           Destination Address             |</p><p class="s31" style="padding-left: 104pt;text-indent: 0pt;text-align: left;">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</p><p class="s31" style="padding-left: 104pt;text-indent: 0pt;text-align: left;">|           Options           |   Padding   |</p><p class="s31" style="padding-left: 104pt;text-indent: 0pt;text-align: left;">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</p><p class="s31" style="padding-top: 2pt;padding-left: 223pt;text-indent: -46pt;line-height: 21pt;text-align: left;">Example Internet Datagram Header Figure 4.</p><p class="s31" style="padding-bottom: 3pt;padding-left: 91pt;text-indent: 0pt;line-height: 8pt;text-align: left;">Note that each tick mark represents one bit position.</p><p style="padding-left: 91pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Image_666.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: left;">This surprisingly descriptive ASCII diagram shows these fields and their positions in the header. Standard protocols have awesome documentation. Similar to the Ethernet header, the IP header also has a protocol field to describe the type of data in the packet and the source and destination addresses for routing. In addition, the header carries a checksum, to help detect transmission errors, and fields to deal with packet fragmentation.</p><p style="padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: left;">The Internet Protocol is mostly used to transmit packets wrapped in higher layers. However, Internet Control Message Protocol (ICMP) packets</p><p style="padding-top: 3pt;padding-left: 91pt;text-indent: 0pt;line-height: 108%;text-align: justify;">also exist on this layer. ICMP packets are used for messaging and diagnostics. IP is less reliable than the post office—there’s no guarantee that an IP packet will actually reach its final destination. If there’s a problem, an ICMP packet is sent back to notify the sender of the problem.</p><p style="padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: left;">ICMP is also commonly used to test for connectivity. ICMP Echo Request and Echo Reply messages are used by a utility called ping. If one host wants to test whether it can route traffic to another host, it pings the remote host by sending an ICMP Echo Request. Upon receipt of the ICMP Echo Request, the remote host sends back an ICMP Echo Reply. These messages can be used to determine the connection latency between the two hosts. However, it is important to remember that ICMP and IP are both connectionless; all this protocol layer really cares about is getting the packet to its destination address.</p><p style="padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: left;">Sometimes a network link will have a limitation on packet size, disallowing the transfer of large packets. IP can deal with this situation by fragmenting packets, as shown here.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s69" style="padding-left: 97pt;text-indent: 0pt;text-align: left;">Large IP packet</p><p style="text-indent: 0pt;text-align: left;"><br/></p><table style="border-collapse:collapse;margin-left:92.87pt" cellspacing="0"><tr style="height:19pt"><td style="width:36pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20"><p class="s59" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Header</p></td><td style="width:70pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20" bgcolor="#B6B7BA"><p class="s59" style="padding-top: 4pt;padding-left: 27pt;padding-right: 25pt;text-indent: 0pt;text-align: center;">Data</p></td><td style="width:71pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20" bgcolor="#B6B7BA"><p class="s59" style="padding-top: 4pt;padding-left: 11pt;text-indent: 0pt;text-align: left;">Data continued</p></td><td style="width:71pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20" bgcolor="#B6B7BA"><p class="s59" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: left;">More data</p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><span><img width="137" height="124" alt="image" src="Image_667.png"/></span></p><p class="s69" style="padding-top: 4pt;padding-left: 11pt;text-indent: 0pt;text-align: left;">Data continued</p><p style="text-indent: 0pt;text-align: left;"/><p class="s69" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Header</p><p style="text-indent: 0pt;text-align: left;"/><p class="s69" style="padding-top: 4pt;padding-left: 27pt;text-indent: 0pt;text-align: center;">Data</p><p style="text-indent: 0pt;text-align: left;"/><p class="s69" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Header</p><p style="text-indent: 0pt;text-align: left;"/><p class="s69" style="padding-top: 2pt;padding-bottom: 2pt;padding-left: 98pt;text-indent: 0pt;text-align: left;">Packet fragments  <span><img width="4" height="30" alt="image" src="Image_668.png"/></span></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s69" style="padding-top: 4pt;padding-left: 18pt;text-indent: 0pt;text-align: left;">More data</p><p style="text-indent: 0pt;text-align: left;"/><p class="s69" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Header</p><p style="text-indent: 0pt;text-align: left;"/><p style="padding-top: 9pt;padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: left;">The packet is broken up into smaller packet fragments that can pass through the network link, IP headers are put on each fragment, and they’re sent off. Each fragment has a different fragment offset value, which is stored in the header. When the destination receives these fragments, the offset values are used to reassemble the original IP packet.</p><p style="padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: left;">Provisions such as fragmentation aid in the delivery of IP packets, but this does nothing to maintain connections or ensure delivery. This is the job of the protocols at the transport layer.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="nav">&nbsp;&nbsp;</p><p class="nav">&nbsp;</p><p class="nav"><a href="part84.htm">&lt; Previous</a><span> | </span><a href="../hacking-the-art-of-exploitation.html">Contents</a><span> | </span><a href="part86.htm">Next &gt;</a></p><p class="nav">&nbsp;&nbsp;</p></body></html>
